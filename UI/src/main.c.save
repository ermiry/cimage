#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <SDL2/SDL.h>
#include <SDL2/SDL_image.h>
#include <stdbool.h>
#include <math.h>
#include "detect-plataform.h"
#include "list.h"
#include <SDL2/SDL_ttf.h>
#include "SDLlib.h"

#define dim 100
#define pressedkey key.keysym.sym
#define ResourcePath "./resources/"

#define PI 3.1416
#define RAD PI/180


typedef struct menuData{
    char dataTitle[100];
    DoubleList *option;
}menuData;

typedef struct{
    int x;
    int xF;
    int y;
    int yF;
}menuPos;

void clean(SDL_Window **window, SDL_Renderer **renderer){
    SDL_DestroyWindow(*window);
    
    SDL_DestroyRenderer(*renderer);
    SDL_Quit();
}


uint32_t ChargingScreen(){
   
    SDL_Init(SDL_INIT_EVERYTHING);
    bool exit = false, forced = false;;
    Sprite sprite;
    int xAux,yAux,cont=0,cont2=0,ff=1,contAux=0,MaxCont=0,aux,MAX = 8;
    Tiempo Time;
    Color color;
    color.a=255;

    //SDL_VARIABLES
    SDL_Window *window = NULL;//principal window
    SDL_Event event;//the event checker
    SDL_Renderer *renderTarget;
    SDL_Texture *texture[2];
    //WE will use renderer for better results
    if(SDL_STARTER(&window,&renderTarget,"cimage")==0){
        texture[0] = LoadTexture(ResourcePath"/CIMAGE33.png",renderTarget);
        texture[1] = LoadTexture(ResourcePath"/background.jpg",renderTarget);
        //game cycle
        while(!exit){
            while(SDL_PollEvent(&event)!=0){//EVENTS
                if(event.type == SDL_QUIT){// || (event.type == SDL_KEYDOWN && event.pressedkey==SDLK_ESCAPE)){
                    exit=true;
                    forced = true;
                }
            }
            /*
            *Render Printing
            * */
            SDL_RenderClear(renderTarget);
            SDL_RenderCopy(renderTarget,texture[1],NULL,NULL);
            SDL_RenderCopy(renderTarget,texture[0],NULL,NULL);
        
            for(int i=cont2; i<cont; i++){//charging rullete
                aux = (360/MAX);
                xAux = 20 * cos((i*aux)*RAD);
                yAux = -20 * sin((i*aux)*RAD);
                if(i%4==0){
                    //SDL_RandomColor(renderTarget,color);
                }
                SDL_SetRenderDrawColor(renderTarget,255,255,255,255);
                SDL_FilledCircle(renderTarget,4,HEIGHT/2 + xAux, WIDTH/2 + 160 + yAux);
            }
            SDL_RenderPresent(renderTarget);
            contAux++;
            if(contAux>32){
                if(cont<MAX){
                    cont++;
                }else{
                    if(cont2<MAX){
                        cont2++;
                    }else{
                        cont2=0;
                        cont=0;
                    }
                    
                }
                    contAux=0;
                    MaxCont++;
            }
            if(MaxCont==2*MAX){
                exit=true;
            }
            
        }
        SDL_DestroyWindow(window);
        SDL_DestroyRenderer(renderTarget);
        SDL_Quit();
        if(forced){
            return -1;
        }else{
            return 0;
        }
    }
}

void SDL_menu(SDL_Renderer **renderTarget,DoubleList **menu, TTF_Font *Sans, SDL_Color Black,Color color, menuPos pos[5], bool selected, int numSelected){
    int i;
    if(!*menu){
        *menu = dlist_init(free);
        menuData *data;
        menuData option;
        char messages[6][100]={"File\0","Edit\0","Insert\0","View\0","Help\0",'\0'};
        char Opt[5][20][20]={{"New","Open","Save","Save As", "Import", "Export", "Exit",'\0'},
                            {"Copy","Cut","Paste",'\0'},
                            {"//NOT YET","//NOT YET","//NOT YET","//NOT YET",'\0'},
                            {"FullScreen","View As frames", "List",'\0'},
                            {"Ask","See manual",'\0'}};
        for( i=0; messages[i][0]!='\0'; i++){
            data = (menuData * ) malloc (sizeof(menuData));
            strcpy(data->dataTitle,messages[i]);
            data->option = dlist_init(free);
                    for(int j = 0;  Opt[i][j][0]!='\0'; j++){
                        strcpy(option.dataTitle , Opt[i][j]);
                        option.option = NULL;
                        
                        if(data->option->start){
                            dlist_insert_after(data->option,LIST_END(data->option),&option);
                        }else{
                            dlist_insert_after(data->option,LIST_START(data->option),&option);
                        }
                    } 
            if((*menu)->start){                
                dlist_insert_after(*menu, LIST_END(*menu),data);
            }else{
                dlist_insert_after(*menu,LIST_START(*menu),data);
            }
        }
    }
    SDL_Rect display, select[5];
    SDL_Surface *text; 
    Color rectColor,blackColor,blue,white;
    //97, 193, 215
    blue.a=140;
    blue.r=97;
    blue.g=193;  
    blue.b=215;
    white.a  = white.r = white.g = white.b = 255;
    rectColor.r=rectColor.g=rectColor.b=100;
    blackColor.r=blackColor.g=blackColor.b=70;
    rectColor.a=blackColor.a=200;
    SDL_Texture *texture;
    SDL_Color Gray = {blackColor.r,blackColor.g,blackColor.b};
    SDL_Color White = {255,255,255};
    char aux[20];
    ListElement *e = LIST_START(*menu);
    display.w = 0;
    for(i=0; e; i++){
        menuData *h = (menuData *) e->data;
        strcpy(aux , h->dataTitle);
        display.x=55 * i;
        display.y=0;
        display.h=20;
        display.w=8*strlen(aux);
        select[i].x = display.x-10;
        select[i].y = display.y;
        select[i].w = display.w+20;
        select[i].h = display.h;
        pos[i].x=display.x;
        pos[i].xF=display.x+display.w;
        pos[i].y=display.y;
        pos[i].yF=display.h;
        SDL_RenderColor(renderTarget,blackColor);
        if(i==numSelected && selected){
            SDL_RenderColor(renderTarget,blue);
            SDL_RenderFillRect(*renderTarget,&select[numSelected]);
            text = TTF_RenderText_Solid(Sans,aux,White);//FIXME: Sometimes I give seg fault?

        }else{
            text = TTF_RenderText_Solid(Sans,aux,Gray);//FIXME: Sometimes I give seg fault?
        }
        texture = SDL_CreateTextureFromSurface(*renderTarget,text);    
        SDL_FreeSurface(text);
        SDL_RenderCopy(*renderTarget,texture,NULL, &display);
        e=e->next;

    }
    SDL_RenderColor(renderTarget,color);
}

void User(){
    //SDL Variables
    SDL_Init(SDL_INIT_EVERYTHING);
    
    SDL_Window *window = NULL;
    SDL_Renderer *renderTarget = NULL;
    SDL_Event event;
    SDL_Surface *surface = NULL;
    SDL_Texture *texture[100];
    SDL_Color White = {255,255,255}, Black = {0,0,0};
    SDL_Rect clk;
    clk.x = 0;
    clk.y = 40;
    clk.h = 20;
    clk.w = 20; 
    //TTF Variables
    TTF_Init();
    DoubleList *menu=NULL;
    menuPos pos[5];
    TTF_Font *Roboto = TTF_OpenFont(ResourcePath"/Fonts/Roboto-Light.ttf",210);
    
    //External variables
    Tiempo Time;
    Time.frameTime = 0;
    Color color,colorLine;
    color.a = colorLine.a = 255;
    menuPos auxiliar;
    int numSelected = -1;
    char counter[100];
    bool exit=false, selected = false, in_menu=false,clicked = false, active_menu = false;
    //Process
    if(SDL_STARTER_FIXED(&window,&renderTarget,"CIMAGE",1280,720)==0){
        color.r=color.g=color.b=230;//Light GRAY
        colorLine.r = colorLine.g = colorLine.b = 120;//GRAY
        SDL_SetWindowResizable(window,true);
        texture[0]=LoadTexture(ResourcePath"/CIMAGE10.png",renderTarget);
        while(!exit){
            SDL_itoa(Time.frameTime,counter,10);
            surface = TTF_RenderText_Solid(Roboto,counter,Black);
            texture[1] = SDL_CreateTextureFromSurface(renderTarget,surface);
            SDL_FreeSurface(surface); 
            SDL_TIME(&Time.prevTime,&Time.currentTime, &Time.deltaTime);
            while(SDL_PollEvent(&event)!=0){
                if(event.type == SDL_KEYDOWN || event.type == SDL_MOUSEMOTION || event.type == SDL_MOUSEBUTTONDOWN){
                    Time.frameTime=0;
                    printf("An event happened");
                }
                if(event.type==SDL_QUIT || (event.type ==SDL_KEYDOWN && event.pressedkey==SDLK_ESCAPE)){
                    exit = true;
                }else if(event.type == click){
                    if(event.button.button == leftClick){
                        auxiliar.x = mouseX;
                        auxiliar.y = mouseY;
                    }
                    if(mouseY<=20 && !clicked){
                        for(int i=0; i<5; i++){
                            if(auxiliar.x>=pos[i].x && auxiliar.x<=pos[i].xF){
                                if(auxiliar.y>=pos[i].y && auxiliar.y<=pos[i].yF){
                                    clicked = true;
                                    selected  =true;
                                    numSelected = i;
                                    break;
                                }
                                else clicked = false;
                            }
                        }
                    }else{
                        clicked = false;
                        selected = false;
                        numSelected = -1;
                    }
                }else if(event.type == SDL_KEYDOWN && (event.pressedkey == SDLK_LALT || event.pressedkey == SDLK_RALT)){
                    active_menu = !active_menu;
                }
            }
/////////////////////////////////////////////////////////////////////////////////////////////Render             
            SDL_RenderClear(renderTarget);
            SDL_RenderColor(&renderTarget,color);
            SDL_Print(&renderTarget,texture[0],1280-138,0,128,128);
            //SDL_Print(&renderTarget,textTexture,0,10,25,115);
            SDL_RenderColor(&renderTarget,colorLine);
            SDL_RenderDrawLine_Gross(&renderTarget,0,1280,120,120,2);
            if(active_menu){
                SDL_menu(&renderTarget,&menu,Roboto,Black,color,pos,selected,numSelected);
            }
            SDL_RenderCopy(renderTarget,texture[1],NULL,&clk);
            SDL_RenderColor(&renderTarget,color);
            SDL_RenderPresent(renderTarget);
///////////////////////////////////////////////////////////////////////////////////////////////////            
            Time.frameTime += Time.deltaTime;
            if(Time.frameTime>=75){
                printf("Entre");
                exit=true;
            
}
        }
        clean(&window,&renderTarget);
    }
}

int main(void){
    uint32_t cont=0;
    //cont  = ChargingScreen();
    if(cont==-1){
        fprintf(stdout,"Exitted program\n");
    }else{
        User();
    }
    return 0;
} 

